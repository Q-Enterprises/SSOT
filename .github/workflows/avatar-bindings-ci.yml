name: Avatar Bindings CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-seal:
    runs-on: ubuntu-latest
    env:
      CONSOLIDATED_MANIFEST: dist/consolidated-manifest.json
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install --no-save ajv-cli
          # Ensure pnpm version is locked if used elsewhere in the spine
          # pnpm@9.1.0 is the standard governance version

      - name: Validate source manifest
        run: |
          if [ ! -f manifest.json ]; then
            echo "::error::manifest.json not found"
            exit 1
          fi
          if [ ! -f schemas/manifest.schema.json ]; then
            echo "::error::schemas/manifest.schema.json not found"
            exit 1
          fi
          npx ajv validate -s schemas/manifest.schema.json -d manifest.json
        shell: bash

      - name: Consolidate manifest (Canonical RFC 8785)
        run: |
          set -euo pipefail
          mkdir -p dist
          # The consolidation script must enforce lexicographical key sorting
          node scripts/consolidate.js
          if [ ! -f "$CONSOLIDATED_MANIFEST" ]; then
            echo "::error::Consolidated manifest failed to generate at $CONSOLIDATED_MANIFEST"
            exit 1
          fi
        shell: bash

      - name: Hash and sign consolidated manifest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          trap 'echo "::error::Hashing or signing failed"' ERR
          
          # Hash generation for Merkle Root anchoring
          sha256sum "$CONSOLIDATED_MANIFEST" | cut -d ' ' -f1 > dist/consolidated-manifest.sha256
          
          # Digital signature using the Sovereign OS private key
          printf '%s\n' "$MANIFEST_PRIVATE_KEY" > manifest_signing_key.pem
          chmod 600 manifest_signing_key.pem
          openssl dgst -sha256 -sign manifest_signing_key.pem -out dist/consolidated-manifest.sig.bin "$CONSOLIDATED_MANIFEST"
          openssl base64 -in dist/consolidated-manifest.sig.bin -out dist/consolidated-manifest.sig
          
          # Cleanup sensitive artifacts
          rm dist/consolidated-manifest.sig.bin manifest_signing_key.pem
        shell: bash
        env:
          MANIFEST_PRIVATE_KEY: ${{ secrets.MANIFEST_PRIVATE_KEY }}

      - name: Hash consolidated manifest (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Generate hash only for PRs (no signing)
          sha256sum "$CONSOLIDATED_MANIFEST" | cut -d ' ' -f1 > dist/consolidated-manifest.sha256
          echo "Hash generated for PR validation (signing skipped)"
        shell: bash

      - name: Emit ledger event to World Engine
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          HASH_VALUE=$(cat dist/consolidated-manifest.sha256)
          curl -sSf -X POST "$LEDGER_ENDPOINT" \
            -H "Authorization: Bearer $LEDGER_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "{\"manifestSha256\":\"$HASH_VALUE\", \"event\":\"BINDING_SEALED\"}"
        shell: bash
        env:
          LEDGER_API_KEY: ${{ secrets.LEDGER_API_KEY }}
          LEDGER_ENDPOINT: ${{ secrets.LEDGER_ENDPOINT }}

      - name: Upload sealed artifacts (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: avatar-bindings-manifest
          path: |
            ${{ env.CONSOLIDATED_MANIFEST }}
            dist/consolidated-manifest.sha256
            dist/consolidated-manifest.sig
          if-no-files-found: error

      - name: Upload validation artifacts (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: avatar-bindings-manifest-validation
          path: |
            ${{ env.CONSOLIDATED_MANIFEST }}
            dist/consolidated-manifest.sha256
          if-no-files-found: error
