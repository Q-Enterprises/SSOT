name: cie-audit-ci
on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  validate-cie-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pynacl

      - name: Run CIE V1 Validator
        id: validator
        run: |
          chmod +x scripts/validate_cie_v1_audit_bundle.py
          python scripts/validate_cie_v1_audit_bundle.py \
            --payloads inputs/cie_v1_audit/payloads.ndjson \
            --receipts ledger/cie_v1/neutrality_receipts.jsonl
        env:
          GITHUB_TOKEN: ${{ secrets.SKULLKEY }}

      - name: Trigger Zapier Webhook
        if: always()
        env:
          ZAPIER_WEBHOOK_URL: ${{ secrets.ZAPIER_WEBHOOK_URL }}
        run: |
          if [ -z "$ZAPIER_WEBHOOK_URL" ]; then
            echo "ZAPIER_WEBHOOK_URL secret is not configured." >&2
            exit 1
          fi
          curl -X POST "$ZAPIER_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "${{ job.status }}",
              "run_id": "${{ github.run_id }}",
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            }'
